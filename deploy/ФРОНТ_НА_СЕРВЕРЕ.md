# Пошаговая настройка фронта на сервере

Фронт (Vite/React) собирается в статические файлы, Nginx раздаёт их и проксирует `/api/` на бэкенд. Ниже — только шаги по фронту.

---

## Шаг 1. Подключиться к серверу по SSH

```bash
ssh root@173.249.3.156
```

(Замените пользователя и IP на свои.)

---

## Шаг 2. Перейти в папку фронта

Путь зависит от того, куда вы залили проект. У вас был путь с дублированием `liquidityscan-web`:

```bash
cd /var/www/liquidityscan/liquidityscan-web/liquidityscan-web/frontend
```

Если у вас структура без дублирования:

```bash
cd /var/www/liquidityscan/liquidityscan-web/frontend
```

Проверьте, что внутри есть `package.json` и папка `src`:

```bash
ls package.json src
```

---

## Шаг 3. Установить зависимости и собрать фронт

```bash
npm ci
```

Если появилась ошибка **ERESOLVE** (конфликт peer-зависимостей, например react-helmet-async и React 19), установите с флагом:

```bash
npm ci --legacy-peer-deps
```

(В проекте есть файл `.npmrc` с `legacy-peer-deps=true` — после заливки обновлённого кода обычный `npm ci` должен проходить.)

Затем сборка:

```bash
npm run build
```

Если сборка выдаёт **`vite: Permission denied`**, выдайте права на скрипты в `node_modules/.bin` и повторите:

```bash
chmod +x node_modules/.bin/*
npm run build
```

После сборки должна появиться папка **`dist`** с файлами `index.html`, `assets/` и т.д.:

```bash
ls dist
```

---

## Шаг 4. Запомнить полный путь к `dist`

Он понадобится для Nginx. Примеры:

- Если фронт в `liquidityscan-web/liquidityscan-web/frontend`:  
  **`/var/www/liquidityscan/liquidityscan-web/liquidityscan-web/frontend/dist`**
- Если фронт в `liquidityscan-web/frontend`:  
  **`/var/www/liquidityscan/liquidityscan-web/frontend/dist`**

Узнать точный путь:

```bash
realpath dist
```

---

## Шаг 5. Настроить Nginx для LiquidityScan

### 5.1. Создать конфиг сайта

Если в проекте есть файл `deploy/nginx-liquidityscan-with-api.conf`, скопируйте его:

```bash
# Из корня проекта (замените путь на свой)
sudo cp /var/www/liquidityscan/deploy/nginx-liquidityscan-with-api.conf /etc/nginx/sites-available/liquidityscan-api
```

Если файла нет — создайте конфиг вручную:

```bash
sudo nano /etc/nginx/sites-available/liquidityscan-api
```

Вставьте (путь `root` замените на свой из шага 4):

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name _;
    root /var/www/liquidityscan/liquidityscan-web/liquidityscan-web/frontend/dist;
    index index.html;
    access_log /var/log/nginx/liquidityscan-api.access.log;
    error_log /var/log/nginx/liquidityscan-api.error.log;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    location /api/ {
        proxy_pass http://127.0.0.1:3002/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

Сохраните: Ctrl+O, Enter, Ctrl+X.

### 5.2. Поправить путь `root` в конфиге (если нужно)

Откройте конфиг и замените путь в `root` на тот, что получили в шаге 4:

```bash
sudo nano /etc/nginx/sites-available/liquidityscan-api
```

Найдите строку `root ...` и укажите полный путь к **вашей** папке `frontend/dist`.

### 5.3. (Опционально) Указать IP в `server_name`

Если хотите, чтобы сайт открывался только по IP, замените `server_name _;` на:

```nginx
server_name 173.249.3.156;
```

(Подставьте свой IP.)

### 5.4. Включить сайт и перезагрузить Nginx

```bash
sudo ln -sf /etc/nginx/sites-available/liquidityscan-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

Если `nginx -t` выдал ошибку — исправьте конфиг (чаще всего неверный путь в `root`).

---

## Шаг 6. Проверить, что бэкенд запущен на порту 3002

Фронт ходит на API по относительному пути `/api/`, Nginx проксирует его на `127.0.0.1:3002`. Бэкенд должен быть запущен:

```bash
pm2 status
# или
curl -s http://127.0.0.1:3002/api/health
```

Если бэкенд не запущен — запустите его (из папки backend: `pm2 start ecosystem.config.cjs` или `npm run start:dev`).

---

## Шаг 7. Google OAuth (если есть вход через Google)

Чтобы после выбора аккаунта Google не перенаправляло на localhost, на **сервере** в `.env` бэкенда укажите публичный callback:

```env
GOOGLE_CALLBACK_URL=http://173.249.3.156/api/auth/google/callback
```

В **Google Cloud Console** → Credentials → ваш OAuth 2.0 Client → в **Authorized redirect URIs** добавьте:

`http://173.249.3.156/api/auth/google/callback`

После правок: `pm2 restart liquidityscan-api`.

---

## Шаг 8. Открыть сайт в браузере

Откройте:

- **http://173.249.3.156** (если в `server_name` указан этот IP или `_`)

Должна загрузиться главная страница приложения. Запросы к API уйдут на `/api/` и через Nginx попадут на бэкенд.

---

## Если на 80 порту уже висит другой сайт (superengulfing)

Тогда по одному IP будут два конфига. Nginx выберет один по `server_name`. Варианты:

1. **Разные порты:** для LiquidityScan сделать отдельный `server` с `listen 8080;` и открывать **http://173.249.3.156:8080**.
2. **Разные домены/поддомены:** указать для LiquidityScan свой `server_name` (например поддомен) и открывать сайт по нему.
3. **Один сайт по IP:** оставить один конфиг по умолчанию (`default_server`) для этого IP, второй — по другому имени.

---

## Повторная сборка после изменений во фронте

После правок в коде фронта:

```bash
cd /var/www/liquidityscan/liquidityscan-web/liquidityscan-web/frontend
npm run build
```

Перезагружать Nginx не нужно — он уже раздаёт папку `dist`, в ней просто появятся новые файлы.
