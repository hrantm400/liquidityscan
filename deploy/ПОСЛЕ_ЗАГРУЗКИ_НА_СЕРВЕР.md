# Что сделать на сервере после загрузки папки

Вы залили всю папку проекта на сервер. На сервере уже работает Nginx и один сайт. Ниже — пошагово, что сделать, чтобы приложение работало **по IP адресу сервера** (фронт + API). Домен подключать не нужно.

---

## Шаг 0. Куда вы загрузили папку

Допустим, вы загрузили проект в каталог на сервере, например:

- `/home/ваш_пользователь/liquidityscan -MEGA`  
  или  
- `/var/www/liquidityscan`

Дальше в командах используется путь **`/var/www/liquidityscan`**. Замените его на свой путь, если он другой.

Внутри этой папки должны быть:

- `liquidityscan-web/backend/` — бэкенд (NestJS)
- `liquidityscan-web/frontend/` — фронт (Vite/React)

---

## Шаг 1. Подключиться к серверу по SSH

```bash
ssh ваш_пользователь@IP_вашего_сервера
```

Узнать IP сервера (если нужно): на сервере выполнить `curl -4 ifconfig.me` или посмотреть в панели хостинга.

---

## Шаг 2. Установить Node.js (если ещё нет)

Проверка:

```bash
node -v
npm -v
```

Если команды не найдены — установите Node.js 18+ (LTS), например:

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
```

---

## Шаг 3. Установить PM2 (если ещё нет)

```bash
sudo npm install -g pm2
```

Проверка: `pm2 -v`

---

## Шаг 4. Собрать бэкенд и создать .env

Перейдите в папку бэкенда (путь замените на свой):

```bash
cd /var/www/liquidityscan/liquidityscan-web/backend
```

Установите зависимости и соберите проект:

```bash
npm ci
npm run build
```

Создайте файл `.env` в этой же папке (скопируйте с примера и отредактируйте):

```bash
cp .env.example .env
nano .env
```

В `.env` обязательно укажите:

- `DATABASE_URL` — строка подключения к PostgreSQL на сервере
- `JWT_SECRET` и `JWT_REFRESH_SECRET` — свои случайные строки
- `SIGNALS_WEBHOOK_SECRET` — секрет для webhook (например `newpass`)
- **Без домена** — укажите URL по IP (замените `ВАШ_IP` на реальный IP сервера):
  - `CORS_ORIGIN=http://ВАШ_IP`
  - `FRONTEND_URL=http://ВАШ_IP`

Сохраните файл (в nano: Ctrl+O, Enter, Ctrl+X).

Сгенерируйте Prisma-клиент (если используете БД):

```bash
npx prisma generate
```

---

## Шаг 5. Запустить бэкенд через PM2

Оставаясь в папке `liquidityscan-web/backend`:

```bash
pm2 start ecosystem.config.cjs
```

Проверка:

```bash
pm2 status
pm2 logs liquidityscan-api
```

Должен быть процесс `liquidityscan-api` в статусе `online`. Логи без ошибок — значит API слушает порт 3000.

Сохранить список процессов PM2 и включить автозапуск после перезагрузки сервера:

```bash
pm2 save
pm2 startup
```

Команду, которую выведет `pm2 startup`, нужно выполнить (скопировать и вставить в терминал).

---

## Шаг 6. Собрать фронтенд (если ещё не собирали локально)

Откройте второй терминал или перейдите в папку фронта:

```bash
cd /var/www/liquidityscan/liquidityscan-web/frontend
npm ci
npm run build
```

После этого появится папка `dist` с готовой статикой.

**Чтобы фронт ходил на API по IP:** перед сборкой в `.env` фронта (или в переменных окружения) задайте `VITE_API_URL=http://ВАШ_IP/api` (замените ВАШ_IP). Если не задать — по умолчанию будет `http://localhost:3000/api`, и с другого компьютера API не откроется. Либо после сборки раздавать фронт через тот же Nginx по IP — тогда запросы идут на тот же хост, и можно не трогать VITE_API_URL (браузер будет слать запросы на `http://IP/api`).

---

## Шаг 7. Настроить Nginx (доступ по IP, без домена)

Добавляем конфиг, который отвечает **только по IP** — ваш другой сайт (по домену) не трогаем.

1. Скопируйте конфиг в каталог Nginx:

   ```bash
   sudo cp /var/www/liquidityscan/deploy/nginx-liquidityscan-with-api.conf /etc/nginx/sites-available/liquidityscan-api
   ```

2. Откройте конфиг и подставьте **IP вашего сервера** и путь к статике:

   ```bash
   sudo nano /etc/nginx/sites-available/liquidityscan-api
   ```

   Замените:
   - **`YOUR_SERVER_IP`** на реальный IP (например `185.216.75.174`) в строке `server_name`.
   - **`root`** — путь к папке со статикой фронта. Если проект лежит в `/var/www/liquidityscan`, оставьте или поправьте на:
     ```nginx
     root /var/www/liquidityscan/liquidityscan-web/frontend/dist;
     ```

   Сохраните файл (Ctrl+O, Enter, Ctrl+X).

3. Включите сайт:

   ```bash
   sudo ln -sf /etc/nginx/sites-available/liquidityscan-api /etc/nginx/sites-enabled/
   ```

4. Проверьте конфигурацию Nginx (важно — не сломает ли это другой сайт):

   ```bash
   sudo nginx -t
   ```

   Должно быть: `syntax is ok` и `test is successful`.

5. Применить настройки:

   ```bash
   sudo systemctl reload nginx
   ```

Первый сайт (по домену) при этом не трогается — у него свой файл в `sites-available` и свой `server_name`.

---

## Шаг 8. Проверить работу (по IP)

1. В браузере откройте: **`http://ВАШ_IP`** (подставьте IP сервера).
   - Должна открыться главная страница (фронт).

2. Проверка API — в браузере или на сервере:
   ```bash
   curl http://ВАШ_IP/api/health
   ```
   Должен вернуться ответ от бэкенда (например `{"status":"ok",...}`).

3. Webhook для Grno (когда будете готовы):
   - URL: **`http://ВАШ_IP/api/signals/webhook`**
   - Заголовок: `X-Webhook-Secret: newpass` (или ваш секрет из `.env`).

4. Если что-то не работает:
   - логи Nginx: `sudo tail -f /var/log/nginx/liquidityscan-api.error.log`
   - логи API: `pm2 logs liquidityscan-api`

---

## Краткая шпаргалка команд (после первой настройки)

| Действие | Команды |
|----------|--------|
| Перезапустить API | `cd liquidityscan-web/backend && pm2 restart liquidityscan-api` |
| Посмотреть логи API | `pm2 logs liquidityscan-api` |
| Статус PM2 | `pm2 status` |
| Проверить Nginx | `sudo nginx -t` |
| Перезагрузить Nginx | `sudo systemctl reload nginx` |

---

## Позже: подключить домен

Когда будете подключать домен (например liquidityscan.io):

1. В Nginx добавьте новый конфиг с `server_name liquidityscan.io www.liquidityscan.io` (или скопируйте текущий конфиг, переименуйте файл и замените `server_name YOUR_SERVER_IP` на `server_name liquidityscan.io www.liquidityscan.io`).
2. В `.env` бэкенда поменяйте `CORS_ORIGIN` и `FRONTEND_URL` на `https://liquidityscan.io`.
3. Настройте SSL (Let's Encrypt): `sudo certbot --nginx -d liquidityscan.io -d www.liquidityscan.io`.
4. Конфиг по IP можно оставить (для проверок) или отключить, убрав симлинк из `sites-enabled`.
